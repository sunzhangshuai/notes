# 生产者

## 概念

生产者发送的消息包含消息体和标签，RabbitMQ根据标签把消息发送给感兴趣的消费者。

### 路由键

生产者将消息发给交换器的时候，指定交换器将消息发送到什么队列或交换器。

## 流程

1. 生产者连接到RabbitMQ实例，建立一个连接、开启一个信道。
2. 生产者声明交换器，设置相关属性：交换器类型、是否持久化等。
3. 生产者声明一个队列，设置相关属性：是否排他、是否持久化、是否自动删除等。
4. 生产者通过绑定键将交换器和队列绑定起来。
5. 生产者发送消息至RabbitMQ实例，其中包含路由键、交换器等信息。
6. 相应的交换器根据接受到的路由键查找相匹配的队列。找到就存入相应队列。
7. 关闭信道。
8. 关闭链接。

## 基本操作

### 发送消息

#### 定义

```java
void basicPublish(
  String exchange, 
  String routingKey, 
  boolean mandatory, 
  boolean immediate, 
  BasicProperties props, 
  byte[] body
) throws IOException;
```

#### 参数

1. exchange：交换器名称。设置为空时，消息会被发送到默认的交换器中。

2. routingKey：指定的路由键。

3. mandatory

   1. **true**：当交换器找不到符合条件的对列，rabbitMQ调用`Basic.Return` 将消息退回给生产者。获取方式如下：

      ```java
      channel.addReturnListener(
        new ReturnListener() {
          @Override
          public void handleReturn(
            int replyCode,
            String replyText,
            String exchange,
            String routingKey,
            AMQP.BasicProperties properties,
            byte[] body) throws IOException {
            System.out.println("Basic.return 返回的消息是:" + new String(body));
          }
      });
      ```

        1. 新增监听器。`channel.addReturnListener`。
        2. 监听器中实现 `handleReturn` 方法。

   2. **false**：当交换器找不到符合条件的对列，直接丢弃消息。

4. immediate：**3.0去掉了**，影响镜像队列性能，增加了代码复杂性。
   1. **true**：交换器将消息路由到队列时，发现队列上不存在消费者，将不会入队，如果所有队列都没消费者，rabbitMQ调用`Basic.Return` 将消息退回给生产者。
   2. **false**：默认。

5. props：消息的基本属性集。
6. body：消息体，真正要发送的消息。

## 确认机制

保证生产者发出的消息能够到达mq。

1. 两种方式互斥。
2. 事务机制是同步的，确认机制可以异步。

### 事务机制

将信道设置为事务模式

```
// 开启事务，将信道设置为事务模式
channel.txSelect();
try {
  channel.basicPublish(
    exchangeName,
    routingKey,
    MessageProperties.PERSISTENT_TEXT_PLAIN,
    "tx".getBytes(StandardCharsets.UTF_8));
  // 提交事务
  channel.txCommit();
} catch (Exception e) {
  e.printStackTrace();
  // 回滚事务
  channel.txRollback();
}
```

使用事务机制会"吸干" RabbitMQ 的性能，非最佳方法。

![事务提交](file:///Users/sunchen/Documents/notes/%E4%B8%AD%E9%97%B4%E4%BB%B6/rabbitmq/%E5%AE%9E%E6%88%98%E6%8C%87%E5%8D%97/imgs/%E4%BA%8B%E5%8A%A1%E6%8F%90%E4%BA%A4.png?lastModify=1627905074)![事务回滚](file:///Users/sunchen/Documents/notes/%E4%B8%AD%E9%97%B4%E4%BB%B6/rabbitmq/%E5%AE%9E%E6%88%98%E6%8C%87%E5%8D%97/imgs/%E4%BA%8B%E5%8A%A1%E5%9B%9E%E6%BB%9A.png?lastModify=1627905074)

### 发送方确认

1. 将信道设置为确认【confirm】模式，在该信道上发送的消息，都会指派一个唯一的消息ID。
2. 消息被投递给所有匹配的队列后，rabbitmq给生产者回复Basic.Ack或Basic.Nack。
3. ![发送方确认](file:///Users/sunchen/Documents/notes/%E4%B8%AD%E9%97%B4%E4%BB%B6/rabbitmq/%E5%AE%9E%E6%88%98%E6%8C%87%E5%8D%97/imgs/%E5%8F%91%E9%80%81%E6%96%B9%E7%A1%AE%E8%AE%A4.png?lastModify=1627905074)
