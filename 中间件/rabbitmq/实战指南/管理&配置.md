# 管理

**大括号代表必选**。**中括号代表可选**。...**代表多值**。

## rabbitmqctl语法

```shell
rabbitmqctl [-n node] [-t timeout] [-q] {command} [command options...]
```

1. node：默认节点是rabbitmq@hostname。
2. timeout：操作超时时间，只用于「list_XXX」的命令。默认无穷大。
3. q：以静默模式启动，屏蔽一些消息的输出。默认不开启。

## 虚拟主机

1. 创建vhost

   ```sh
   rabbitmqctl add_vhost {vhostName}
   ```

2. 查看vhost列表相关信息

   ```shell
   rabbitmqctl list_vhosts [vhostinfoitem...]
   ```

   1. vhostinfoitem取值有两个，代表结果要展示的列。
   2. name：vhost名称。
   3. tracing：表示是否使用了trace功能。

3. 删除vhost

   ```shell
   rabbitmqctl delete_vhost {vhostName}
   ```

## 用户权限

权限控制以vhost为单位。

1. 授予权限

   ```shell
   rabbitmqctl set_permissions [-p host] {user} {conf} {write} {read}
   ```

   1. user：可以访问指定vhost的用户名。

   2. conf：可配置权限的正则表达式，用于匹配资源。指的是队列和交换器的创建及删除之类的操作。

   3. write：可写权限的正则表达式，用于匹配资源。指的是发布消息。

   4. Read：可读权限的正则表达式，用于匹配资源。指的是与消息有关的操作。

   5. 命令与权限的映射关系：

      ![amqp与权限的对应关系](imgs/amqp与权限的对应关系.png)

2. 清除权限

   ```shell
   rabbitmqctl clear_permissions [-p host] {userName}
   ```

3. 列举虚拟主机纬度的权限信息

   ```shell
   rabbitmqctl list_permissions [-p host]
   ```

4. 列举用户纬度的权限信息

   ```shell
   rabbitmqctl list_user_permissions {userName}
   ```

## 用户管理

1. 创建用户

   ```shell
   rabbitmqctl add_user {userName} {password}
   ```

2. 修改密码

   ```
   rabbitmqctl change_password {userName} {newPassword}
   ```

3. 清除密码

   ```shell
   rabbitmqctl clear_password {userName}
   ```

4. 密码验证

   ```shell
   rabbitmqctl authenticate_user {userName} {password}
   ```

5. 删除用户

   ```shell
   rabbitmqctl delete_user {userName}
   ```

6. 查看用户列表

   ```shell
   rabbitmqctl list_users
   ```

   每个结果行都包含用户的名称和用户的角色【tags】，角色如下：

   1. none：无任何角色。新创建的用户的角色默认为none。
   2. management：可访问web管理页面。
   3. policymaker：包括management的所有权限，并且可以管理策略和参数。
   4. monitoring：包括management的所有权限，并且可以看到连接、信道及节点相关信息。
   5. administartor：包括monitoring的所有权限，并且可以管理用户，虚拟主机，权限，策略，参数等。代表最高权限。

7. 设置用户角色

   ```shell
   rabbitmqctl set_user_tags {userName} {tags...}
   ```

## 插件

1. 查看插件使用情况

   ```shell
   rabbitmq-plugins list
   ```

   1. [E*]：显式启动
   2. [e*]：隐式启动
   3. [ ]：没启动

## web管理

1. [地址](http://localhost:15672)：http://localhost:15672

2. guest账户不可以访问远程web管理界面。

3. 非guest的非none账户可以访问远程web管理界面。

4. 开启命令

   ```shell
   rabbitmq-plugins enable rabbitmq_management
   ```

5. 关闭命令

   ```shell
   rabbitmq-plugins disable rabbitmq_management
   ```

## 应用管理

1. 停止运行：停止运行`Erlang`虚拟机和服务应用。

   ```shell
   rabbitmqctl stop [pid_file]
   ```

   1. pid_file：通过rabbitmq-server启动生成的文件，加-detach不产生。意思为需要等待指定进程的结束。

2. 停止运行：阻塞直到`Erlang`虚拟机进程退出。

   ```shell
   rabbitmqctl shutdown
   ```

3. 停止服务应用

   ```shell
   rabbitmqctl stop_app
   ```

4. 启动服务应用

   ```shell
   rabbitmqctl start_app
   ```

5. 等待rabbitmq应用的启动

   ```shell
   rabbitmqctl wait [pid_file]
   ```

6. 初始化服务

   ```shell
   rabbitmqctl reset
   ```

7. 强制初始化服务

   ```shell
   rabbitmqctl force_reset
   ```

8. 切割日志，原日志存于日志名+后缀的文件中。

   ```shell
   rabbitmqctl rotate_logs {suffix}
   ```

   不指定suffix：只是重新打开，而不发生轮换。

9. 将部分代码用HiPE编译

   ```shell
   rabbitmqctl hipe_compile {directory}
   ```

## 集群管理

1. 将节点加入指定集群

   ```shell
   rabbitmqctl join_cluster {cluster_node} [--ram]
   ```

2. 显示集群状态

   ```shell
   rabbitmqctl cluster_status
   ```

3. 修改集群节点的类型

   ```shell
   rabbitmqctl change_cluster_node_type {disc|ram}
   ```

4. 将节点从集群中删除，允许离线执行。

   ```shell
   rabbitmqctl forget_cluster_node [--offline]
   ```

5. 在集群中的节点应用启动前咨询节点的最新信息，并更新相应的集群信息，不加入集群。

   ```shell
   rabbitmqctl update_cluster_nodes {clusterNode}
   ```

6. 确保节点可以启动。

   ```shell
   rabbitmqctl force_boot
   ```

7. 指示未同步队列queue的slave镜像可以同步master镜像的内容。同步期间阻塞，直到同步完成。

   ```shell
   rabbitmqctl sync_queue [-p vhost] {queue}
   ```

8. 取消同步队列

   ```shell
   rabbitmqctl cancel_sync_queue [-p vhost] {queue}
   ```

9. 设置集群名称。

   ```shell
   rabbitmqctl set_cluster_name {name}
   ```

## 服务器状态

### 队列的详细信息

```shell
rabbitmqctl list_queues [-p vhost] [queueInfoItem...]
```

queueInfoItem用于指示哪些队列的信息项会展示在结果集中。如果没有指定 queueinfoitems ，那么此命令将显示**队列的名称**和**消息的个数**。

1. name：队列名称。
2. durable：队列是否持久化。
3. auto_delete：队列是否自动删除。
4. arguments：队列的参数。
5. policy：队列上应用的策略名称。
6. pid：队列关联的`Erlang`进程的id。
7. owner_pid：处理排他队列的`Erlang`进程的id，如果此队列是非排他的，此值为空。
8. exclusive：队列是否是排他的。
9. exclusive_consumer_pid：订阅到此排他队列的消费者相关的信道关联的`Erlang`进程 。如果此队列是非排他的，此值将为空。
10. exclusive_consumer_tag：订阅到此排他队列的消费者的 consumerTag 如果此队列是非排他的，此值将为空。
11. messages_ready：准备发送给客户端的消息个数。
12. messages_unacknowledged：发送给客户端但尚未应答的消息个数。
13. messages：准备发送给客户端和未应答消息的总和。
14. messages_ready_ram：驻留在内存中 messages_ready 的消息个数。
15. messages_unacknowledged_ram：驻留在内存中 messages_unacknowledged 的消息个数。
16. messages_ram：驻留在内存中的消息总数。
17. messages_persistent：队列中持久化消息的个数，对于非持久化队列来说总是0。
18. messages_bytes：队列中所有消息的大小总和，这里不包括消息属性或者任何其他开销。
19. messages_bytes_ready：准备发送给客户端的消息的大小总和。
20. messages_bytes_unacknowledged：发送给客户端但尚未应答的消息的大小总和。
21. messages_bytes_ram：驻留在内存中的消息的大小总和。
22. messages_bytes_persistent：队列中持久化的 messages_bytes。
23. disk_reads：从队列启动开始，已从磁盘中读取该队列的消息总次数。
24. disk_writes：从队列启动开始，已向磁盘队列写消息的总次数。
25. consumer：消费者数目。
26. consumer_utilisation：队列中的消息能够立刻投递给消费者的比率。介于0~1之间 。这个受网络拥塞或者 `Basic.Qos` 的影响而小于1。
27. memory：与队列相关的 `Erlang` 进程所消耗的内存字节数，包括栈、堆及内部结构。
28. slave_pids：如果队列是镜像的，列出所有 slave 镜像的 pid。
29. synchronised_slave_pids：如果队列是镜像的，列出所有已经同步的 slave 镜像的pid。
30. state：队列状态。正常情况下是 running。如果队列正常同步数据可能会有 syncing、MsgCount 的状态。

### 交换器的详细信息

```shell
rabbitmqctl list_exchanges [-p vhost] [exchangeInfoItem...]
```

默认显示**名称**和**类型**

1. name：交换器名称。
2. type：交换器类型。
3. durable：设置是否持久化。
4. auto_delete：设置是否自动删除。
5. internal：是否是内置的。
6. arguments：其他一些结构化参数，比如 alternate-exchange。
7. policy：应用到交换器上的策略名称。

### 绑定关系的细节

```shell
rabbitmqctl list_bindings [-p vhost] [bindingInfoItem...]
```

默认展示所有条目。

1. source_name: 绑定中消息来源的名称。
2. source_kind：绑定中消息来源的类别。
3. destination_name：绑定中消息目的地的名称。
4. destination_kind：绑定中消息目的地的种类。
5. routing_key：绑定的路由键。
6. arguments：绑定的参数。

### TCP/IP连接的统计信息

```shell
rabbitmqctl list_connnects [connectionInfoItem...]
```

默认显示user、peer_host、peer_port和state。

1. pid：与连接相关的 `Erlang` 进程 ID。
2. name：连接的名称。
3. port：服务器端口。
4. host：返回反向 DNS 获取的服务器主机名称，或者 IP 地址，或者未启用。
5. peer_port：服务器对端端口。当一个客户端与服务器连接时，这个客户端的端口就peer_port。
6. peer_host：返回反向 DNS 获取的对端主机名称，或者 地址，或者未启用。
7. ssl：是否启用 SSL。
8. ssl_protocol：SSL 协议，如 tlsvl。
9. ssl_key_exchange：SSL 密钥交换算法，如 rsa。
10. ssl_cipher：SSL 加密算法，如 aes_256_cbc。
11. ssl_hash: SSL 哈希算法，如 sha。
12. peer_cert_subject：对端的 SSL 安全证书的主题，基于RFC4514 的形式。
13. peer_cert_issuer：对端 SSL 安全证书的发行者， 基于 RFC4514 的形式
14. peer_cert_validity：对端 SSL 安全证书的有效期。
15. state：连接状态，包括 starting、tuning、opening、running、flow、blocking、blocked、closing、closed 这几种。
16. channels：该连接中的信道个数。
17. protocol：使用的 AMQP 协议的版本，当前是 {0.9.1} 或者 {0.8.0} 。注意，如果客户端请求的是 AMQP 0.9 的连接， RabbitMQ 也会将其视为0.9.1。
18. auth_mechanism：使用的 SASL 认证机制，如 PLAIN、AMQPLAIN、EXTERNAL、RABBIT-CR-DEMO。
19. user：与连接相关的用户名。
20. vhost：与连接相关的 vhost 的名称。
21. timeout：连接超时/协商的心跳间隔，单位为秒。
22. frame_max：最大传输帧的大小，单位为B。
23. channel_max：此连接上信道的最大数量。如果值 0，则表示无上限，但客户端会将0转变为 65535。
24. client_properties：在建立连接期间由客户端发送的信息属性。
25. recv_oct：收到的字节数。
26. recv_cnt：收到的数据包个数。
27. send_oct：发送的字节数。
28. send_cnt：发送的数据包个数。
29. send_pend：发送队列大小。
30. connected_at：连接建立的时间戳。

### 信道的信息

```shell
rabbitmqctl list_channels [channelInfoItem...]
```

默认显示 pid、user、consumer_count、messages_unacknowledged。

1. pid：与连接相关的 `Erlang` 进程 ID。
2. connection：信道所属连接的  `Erlang` 进程 ID。
3. name：信道的名称。
4. number：信道的序号。
5. user：与信道相关的用户名称。
6. vhost：与信道相关的vhost。
7. transactional：信道是否处于事务模式。
8. confirm：信道是否处于 publisher confirm 模式。
9. consumer_count：信道中的消费者的个数。
10. messages_unacknowledged：已投递但是还未被 ack 的消息个数。
11. messages_uncommitted：已接收但是还未提交事务的消息个数。
12. acks_uncommitted：已 ack 收到但是还未提交事务的消息个数。
13. messages_unconfirmed：己发送但是还未确认的消息个数。 如果信道不处于 publisher confmn 模式下 ，则此值为0。
14. perfetch_count：新消费者的 Qos 个数限制。0表示无上限。
15. global_prefetch_count：整个信道的 Qos 个数限制。0表示无上限。

### 消费者信息

```shell
rabbitmqctl list_consumers [-p vhost]
```

1. 已订阅队列的名称。
2. 相关信道的进程标识。
3. consumerTag。
4. 是否需要消费端确认。
5. prefetch_ count。
6. 参数列表。

### Broker状态

```shell
rabbitmqctl status
```

### 健康检查

```shell
rabbitmqctl node_health_check
```

### 显示每个运行程序环境中每个变量的名称和值。

```
rabbitmqctl environment
```

### 为所有服务器状态生成1个服务器状态报告，并将输出重定向到1个文件。

```shell
rabbitmqctl report [> report.txt]
```

### 执行任意 Erlang 表达式

```shell
rabbitmqctl eval {expr}
```

1. 创建交换器：`declare(XName , Type , Durable , AutoDelete , Internal, Args)`。
2. 创建队列：`declare(QueueName , Durable , AutoDelete , Args, Owner)`。
   1. Owner：用于队列的独占模式， 一般设置为 none。

## HTTPAPI接口管理

[api文档](http://localhost:15672/api/index.html)：http://localhost:15672/api/index.html

# 配置

## 环境变量

## 配置文件

## 参数及策略