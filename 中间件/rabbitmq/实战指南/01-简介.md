# 简介

## 消息中间件作用

1. 解耦。
2. 冗余（存储）：可以持久化数据直至处理完成，避免数据丢失。
3. 扩展性：容易提升消息入队和处理的效率。
4. 削峰。
5. 可恢复性：系统一部分组件失效了，不影响整个系统。处理消息的组件挂掉，加入消息中间件的消息仍然可以在组件恢复后进行处理。
6. 顺序保证。
7. 缓冲。
8. 异步通信。

## RabbitMQ特点

1. 可靠性：持久化、传输确认、发布确认。
2. 路由灵活。
3. 扩展性：集群。
4. 高可用性：队列可以在集群中的机器上设置镜像。
5. 多种协议。
6. 多语言客户端。
7. 管理界面。`http://localhost:15672/#/`
8. 插件机制。

# 基础命令

## 启动

```shell
rabbitmq-server -detached
```

1. detached：以守护进程的方式在后台运行。

## 查看状态

```shell
rabbitmqctl status
```

```text
Status of node rabbit@localhost ...
Runtime

OS PID: 97385
OS: macOS
Uptime (seconds): 27
Is under maintenance?: false
RabbitMQ version: 3.8.17
Node name: rabbit@localhost
Erlang configuration: Erlang/OTP 24 [erts-12.0.2] [source] [64-bit] [smp:8:8] [ds:8:8:10] [async-threads:1] [jit] [dtrace]
Erlang processes: 463 used, 1048576 limit
Scheduler run queue: 1
Cluster heartbeat timeout (net_ticktime): 60

Plugins

Enabled plugin file: /usr/local/etc/rabbitmq/enabled_plugins
Enabled plugins:

 * rabbitmq_stomp
 * rabbitmq_mqtt
 * rabbitmq_amqp1_0
 * amqp10_common
 * rabbitmq_management
 * amqp_client
 * rabbitmq_web_dispatch
 * cowboy
 * cowlib
 * rabbitmq_management_agent

Data directory

Node data directory: /usr/local/var/lib/rabbitmq/mnesia/rabbit@localhost
Raft data directory: /usr/local/var/lib/rabbitmq/mnesia/rabbit@localhost/quorum/rabbit@localhost

Config files


Log file(s)

 * /usr/local/var/log/rabbitmq/rabbit@localhost.log
 * /usr/local/var/log/rabbitmq/rabbit@localhost_upgrade.log

Alarms

(none)

Memory

Total memory used: 0.1537 gb
Calculation strategy: rss
Memory high watermark setting: 0.4 of available memory, computed to: 3.436 gb

reserved_unallocated: 0.0726 gb (47.19 %)
code: 0.0368 gb (23.95 %)
other_proc: 0.0353 gb (22.94 %)
other_system: 0.0166 gb (10.79 %)
other_ets: 0.0037 gb (2.4 %)
plugins: 0.0035 gb (2.3 %)
atom: 0.0015 gb (0.95 %)
metrics: 2.0e-4 gb (0.16 %)
binary: 2.0e-4 gb (0.15 %)
mgmt_db: 2.0e-4 gb (0.12 %)
queue_procs: 2.0e-4 gb (0.1 %)
mnesia: 1.0e-4 gb (0.08 %)
quorum_queue_procs: 1.0e-4 gb (0.07 %)
msg_index: 1.0e-4 gb (0.06 %)
quorum_ets: 1.0e-4 gb (0.03 %)
connection_other: 0.0 gb (0.0 %)
allocated_unused: 0.0 gb (0.0 %)
connection_channels: 0.0 gb (0.0 %)
connection_readers: 0.0 gb (0.0 %)
connection_writers: 0.0 gb (0.0 %)
queue_slave_procs: 0.0 gb (0.0 %)

File Descriptors

Total: 6, limit: 7071
Sockets: 0, limit: 6361

Free Disk Space

Low free disk space watermark: 0.05 gb
Free disk space: 392.3006 gb

Totals

Connection count: 0
Queue count: 6
Virtual host count: 3

Listeners

Interface: [::], port: 15672, protocol: http, purpose: HTTP API
Interface: [::], port: 1883, protocol: mqtt, purpose: MQTT
Interface: [::], port: 61613, protocol: stomp, purpose: STOMP
Interface: [::], port: 25672, protocol: clustering, purpose: inter-node and CLI tool communication
Interface: 127.0.0.1, port: 5672, protocol: amqp, purpose: AMQP 0-9-1 and AMQP 1.0
```

## 查看集群信息

```shell
rabbitmqctl cluster_status
```

```text
Cluster status of node rabbit@localhost ...
Basics

Cluster name: rabbit@sunchendeMacBook-Pro

Disk Nodes

rabbit@localhost

Running Nodes

rabbit@localhost

Versions

rabbit@localhost: RabbitMQ 3.8.17 on Erlang 24.0.2

Maintenance status

Node: rabbit@localhost, status: not under maintenance

Alarms

(none)

Network Partitions

(none)

Listeners

Node: rabbit@localhost, interface: [::], port: 15672, protocol: http, purpose: HTTP API
Node: rabbit@localhost, interface: [::], port: 1883, protocol: mqtt, purpose: MQTT
Node: rabbit@localhost, interface: [::], port: 61613, protocol: stomp, purpose: STOMP
Node: rabbit@localhost, interface: [::], port: 25672, protocol: clustering, purpose: inter-node and CLI tool communication
Node: rabbit@localhost, interface: 127.0.0.1, port: 5672, protocol: amqp, purpose: AMQP 0-9-1 and AMQP 1.0

Feature flags

Flag: drop_unroutable_metric, state: disabled
Flag: empty_basic_get_metric, state: disabled
Flag: implicit_default_bindings, state: enabled
Flag: maintenance_mode_status, state: disabled
Flag: quorum_queue, state: enabled
Flag: user_limits, state: disabled
Flag: virtual_host_metadata, state: enabled
```

## 查看队列消费状态

```shell
rabbitmqctl list_queues name message_ready messages_acknowledged
```

# 组成部分

## 虚拟主机

1. 本质上是一个独立的小型rabbitmq服务器。
2. vhost之间绝对隔离。
3. 客户端连接时必须指定一个vhost【默认「/」】。
4. 用户可以拥有多个虚拟主机的权限。

## 消息

1. 消息分为两部分：
   1. 消息体【payload】：带有业务逻辑的数据。
   2. 标签【label】：表述消息，交换器、路由键。
2. 在消息路由的过程中，消息的标签会丢弃掉。队列中只有消息体。

## 生产者

生产者发送的消息包含消息体和标签，RabbitMQ根据标签把消息发送给感兴趣的消费者。

## 消费者

连接服务器，订阅到**队列**上。

## 服务节点【Broker】

mq实例，一般是一台服务器。

## 队列

1. 消息都只能存储在队列中，kafka是存储在主题逻辑层面。
2. 多个消费者可以订阅同一队列，队列中的消息会被平均分摊。
3. 不支持队列层面的广播。

## 交换器

生产者将消息发送到交换器，由交换器将消息路由到一个或多个队列。

### 交换器类型

#### fanout

把所有发送到该交换机的消息路由到所有与该交换器绑定的队列中。

#### direct

把消息路由到 BingdingKey 和 RoutingKey完全匹配的队列中。

#### topic

把消息路由到  BingdingKey 和 RoutingKey 相匹配的队列中。

1. BingdingKey和RoutingKey 都是以`.`分隔的字符串。每一段称为一个单词。
2. BingdingKey存在两种特殊字符串，用于做模糊匹配。
   1. `*`：匹配一个单词。
   2. `#`：匹配多个单词。

#### headers

1. 不依赖路由键的匹配规则。依赖headers属性。
2. 在绑定队列和交换器时制定一组键值对。
3. 对比消息中的headers是否完全匹配队列和交换器绑定时指定的键值对。
4. 性能很差，基本不用。

## 路由键【RoutingKey】

生产者将消息发给交换器的时候，指定交换器将消息发送到什么队列或交换器。

## 绑定键【BingingKey】

交换器和内置交换器或队列的绑定关系，当路由键和绑定键匹配时，消息会传输。

## 信道【Channel】

1. 每个信道都会被指定一个唯一的ID。
2. 是建立在连接上的虚拟信道。
3. 多线程间复用TCP连接，起到节省作用。

# 运转流程

## 生产者发消息的过程

1. 生产者连接到RabbitMQ实例，建立一个连接、开启一个信道。
2. 生产者声明交换器，设置相关属性：交换器类型、是否持久化等。
3. 生产者声明一个队列，设置相关属性：是否排他、是否持久化、是否自动删除等。
4. 生产者通过绑定键将交换器和队列绑定起来。
5. 生产者发送消息至RabbitMQ实例，其中包含路由键、交换器等信息。
6. 相应的交换器根据接受到的路由键查找相匹配的队列。找到就存入相应队列。
7. 关闭信道。
8. 关闭链接。

## 消费者接收消息的过程

1. 消费者连接到RabbitMQ实例，建立一个连接、开启一个信道。
2. 请求消费队列中的消息，可能设置相应的回调函数，做一些准备工作。
3. 等待实例回应并投递消息，消费者接收。
4. 消费者确认【ack】消息接受。
5. RabbitMQ从队列中删除已被确认的消息。
6. 关闭信道。
7. 关闭连接。

# AMQP协议

## 协议层

1. Module Layer：协议最高层，定义供客户端调用的命令。
2. Session Layer：
   1. 中间层，负责将客户端的命令发送给服务器，将应答返回给客户端。
   2. 为客户端与服务端之间的通信提供可靠性同步机制和错误处理。
3. Transport Layer：最底层，负责传输二进制数据流。
