# 网络分区

## 概念

一个分布式系统里面，节点组成的网络本来应该是连通的。但可能因为一些故障，有些节点之间不连通了，整个网络分成了几块区域。数据散布在了这些不连通的区域中。这就叫分区。

## 意义

与rabbitmq的数据一致性复制原理有关。rabbitmq的镜像队列是环形的逻辑结构，如果其中一个节点不可用，会导致整个集群不可用，引入网络分区，将不可用的节点剥离，保证可用性，等网络恢复，再加入集群。

## 判定

1. RabbitMQ 集群内部的每个节点之间，会每隔四分之一的 net_ticktime 计一次应答。

2. 如果有任何数据被写入节点中，则该节点被认为已经被应答了。

3. 如果连续4次某节点都没有被 ticked， 则可以判定该节点已 down，其余节点可将该节点剥离出当前分区。

### net_ticktime

- 节点内部通信超时时间，默认60s。
- 将连续4次的 tick 时间记为T ，那么T的取值范围为 0.75 x net_ticktime < T < 1.25 x net_ticktime。

### heartbeat_time

客户端与节点之间通信的心跳时间，默认60s。

### 查看是否出现网络分区

1. 通过查看rabbitmq的服务日志：通过` running_partitioned_network` 关键字查看。

2. 通过 `rabbitmqctl cluster_status`查看。

   ```shell
   [{nodes, [{disc, [rabbit@nodel, rabbit@node2, rabbit@node3]}]}, 
   {running_nodes, [rabbit@node3, rabbit@nodel]} , 
   {cluster_name, <<"rabbit@nodel">>} , 
   {partitions [{rabbit@node3, [rabbit@node2]} , {rabbit@nodel, [rabbit@node2]}]}]
   ```

   上面 partitions 项中的内容表示：

   1. rabbit@node3 和 rabbit@node2 发生了分区，即 {rabbit@node3, [rabbit@node2]}

   2. rabbit@node1 和 rabbit@node2 发生了分区，即 {rabbit@node1, [rabbit@node2]}

3. 通过web管理界面查看：是否有 *network partition detected* 警告。

4. 调用API查看

   ```shell
   #查看
   curl -i -u username:password -H "content-type:application/json" -X GET http://ip:port/api/nodes
   #内容
   "partitions":[ 
    	"rabbit@node2" 
   ]
   ```

## 模拟网络分区

- iptables 封禁/解封地址或者端口号

  1. 在某个节点进行封禁

     ```shell
     iptables -A INPUT -p tcp --dport 25672 -j DROP 
     iptables -A OUTPUT -p tcp --dport 25672 -j DROP
     ```

  2. 查看日志。

  3. 解禁

     ```shell
     iptables -D INPUT 1 
     iptables -D OUTPUT 1
     ```

- 关闭/开启网卡

  1. 查看网卡名称

     ```shell
     ifconfig
     ```

  2. 在某个节点上关闭网卡

     ```shell
     ifdown <网卡名>
     ```

  3. 查看日志，是否有分区

  4. 开启网卡

     ```shell
     ifup <网卡名>
     ```

- 挂起/恢复操作系统。





