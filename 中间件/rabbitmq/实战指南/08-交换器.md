# 交换器

## 概念

1. 生产者将消息发送到交换器，由交换器将消息路由到一个或多个队列。
2. 建议通过后台管理系统预先创建资源。


### 交换器类型

#### fanout

把所有发送到该交换机的消息路由到所有与该交换器绑定的队列中。

#### direct

把消息路由到 BingdingKey 和 RoutingKey完全匹配的队列中。

#### topic

把消息路由到  BingdingKey 和 RoutingKey 相匹配的队列中。

1. BingdingKey和RoutingKey 都是以`.`分隔的字符串。每一段称为一个单词。
2. BingdingKey存在两种特殊字符串，用于做模糊匹配。
   1. `*`：匹配一个单词。
   2. `#`：匹配多个单词。

#### headers

1. 不依赖路由键的匹配规则。依赖headers属性。
2. 在绑定队列和交换器时制定一组键值对。
3. 对比消息中的headers是否完全匹配队列和交换器绑定时指定的键值对。
4. 性能很差，基本不用。

## 基本操作

### 声明

#### 定义

```java
Exchange.DeclareOk exchangeDeclare(
 	String exchange,
  BuiltinExchangeType type,
  boolean durable,
  boolean autoDelete,
  boolean internal,
  Map<String, Object> arguments
) throws IOException;
```

#### 参数

1. exchange：交换器名称。
2. type：交换器类型，fanout、direct、topic等。
3. durable：是否持久化。true为持久化，将交换器存盘。不持久化的影响：rabbitmq重启时，交换器元数据会丢失，消息不会丢失，且不能将消息再发送给这个交换器了。
4. autoDelete：自动删除。true为当所有绑定队列都不在使用时，自动删除交换器。【**一次性**】
   1. 前提：必须有交换机或队列绑定过。
   2. 所有绑定都断开时，自动删除。
5. internal：是否设置成内置的。true为必须通过交换器路由到此交换器。
6. arguments：结构化参数。
   1. 备份交换器：alternate-exchange

### 删除

```java
DeleteOk exchangeDelete(
  String exchange
) throws IOException;
```

## 应用

### 备份交换器

Alternate Exchange

#### 适用场景

1. 当 `mandatory` 为false时，不会将未匹配到的消息返回给生产者，此时可使用备份交换器。
2. 当使用备份交换器时，`mandatory` 参数不生效。

#### 使用方式

```shell
// 1. 声明主交换器时将参数传入
args.put("alternate-exchange", "备份交换器名称");
// 2. 命令行设置
rabbitmqctl set_policy AE "^主交换器名称$" `{"alternate-exchange": "备份交换器名称"}`
```

#### 注意事项

1. 备份交换器最好设置为**fanout**类型。
2. 消息被发送到备份交换器时的路由键和从生产者发出的路由键是一样的。

#### 特殊情况

1. **备份交换器不存在**，客户端、服务端不会出现异常，消息丢失。
2. **备份交换器没有绑定任何队列**，客户端、服务端不会出现异常，消息丢失。
3. **备份交换器没有任何匹配的队列**，客户端、服务端不会出现异常，消息丢失。
4. 备份交换器和 `mandatory` **一起使用**， `mandatory` 参数无效。

#### [参考代码](exercises/src/main/java/com/ae)

## 管理

```shell
rabbitmqctl list_exchanges [-p vhost] [exchangeInfoItem...]
```

默认显示**名称**和**类型**

1. name：交换器名称。
2. type：交换器类型。
3. durable：设置是否持久化。
4. auto_delete：设置是否自动删除。
5. internal：是否是内置的。
6. arguments：其他一些结构化参数，比如 alternate-exchange。
7. policy：应用到交换器上的策略名称。

