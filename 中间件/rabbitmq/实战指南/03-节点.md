# 节点

## 概念

broker。mq实例，一般是一台服务器。

### 远程登录

修改rabbitmq-env.conf，NODE_IP_ADDRESS 置为空，[详见](https://blog.csdn.net/dongzhensong/article/details/88249834)。

### HTTPAPI接口管理

[api文档](http://localhost:15672/api/index.html)：http://localhost:15672/api/index.html

## 基本操作

### rabbitmqctl

#### 语法

**大括号代表必选**。**中括号代表可选**。...**代表多值**。

```shell
rabbitmqctl [-n node] [-t timeout] [-q] {command} [command options...]
```

1. node：默认节点是rabbitmq@hostname。
2. timeout：操作超时时间，只用于「list_XXX」的命令。默认无穷大。
3. q：以静默模式启动，屏蔽一些消息的输出。默认不开启。

## 管理

### 查看状态

```shell
rabbitmqctl status
```

```text
Status of node rabbit@localhost ...
Runtime

OS PID: 97385
OS: macOS
Uptime (seconds): 27
Is under maintenance?: false
RabbitMQ version: 3.8.17
Node name: rabbit@localhost
Erlang configuration: Erlang/OTP 24 [erts-12.0.2] [source] [64-bit] [smp:8:8] [ds:8:8:10] [async-threads:1] [jit] [dtrace]
Erlang processes: 463 used, 1048576 limit
Scheduler run queue: 1
Cluster heartbeat timeout (net_ticktime): 60

Plugins

Enabled plugin file: /usr/local/etc/rabbitmq/enabled_plugins
Enabled plugins:

 * rabbitmq_stomp
 * rabbitmq_mqtt
 * rabbitmq_amqp1_0
 * amqp10_common
 * rabbitmq_management
 * amqp_client
 * rabbitmq_web_dispatch
 * cowboy
 * cowlib
 * rabbitmq_management_agent

Data directory

Node data directory: /usr/local/var/lib/rabbitmq/mnesia/rabbit@localhost
Raft data directory: /usr/local/var/lib/rabbitmq/mnesia/rabbit@localhost/quorum/rabbit@localhost

Config files


Log file(s)

 * /usr/local/var/log/rabbitmq/rabbit@localhost.log
 * /usr/local/var/log/rabbitmq/rabbit@localhost_upgrade.log

Alarms

(none)

Memory

Total memory used: 0.1537 gb
Calculation strategy: rss
Memory high watermark setting: 0.4 of available memory, computed to: 3.436 gb

reserved_unallocated: 0.0726 gb (47.19 %)
code: 0.0368 gb (23.95 %)
other_proc: 0.0353 gb (22.94 %)
other_system: 0.0166 gb (10.79 %)
other_ets: 0.0037 gb (2.4 %)
plugins: 0.0035 gb (2.3 %)
atom: 0.0015 gb (0.95 %)
metrics: 2.0e-4 gb (0.16 %)
binary: 2.0e-4 gb (0.15 %)
mgmt_db: 2.0e-4 gb (0.12 %)
queue_procs: 2.0e-4 gb (0.1 %)
mnesia: 1.0e-4 gb (0.08 %)
quorum_queue_procs: 1.0e-4 gb (0.07 %)
msg_index: 1.0e-4 gb (0.06 %)
quorum_ets: 1.0e-4 gb (0.03 %)
connection_other: 0.0 gb (0.0 %)
allocated_unused: 0.0 gb (0.0 %)
connection_channels: 0.0 gb (0.0 %)
connection_readers: 0.0 gb (0.0 %)
connection_writers: 0.0 gb (0.0 %)
queue_slave_procs: 0.0 gb (0.0 %)

File Descriptors

Total: 6, limit: 7071
Sockets: 0, limit: 6361

Free Disk Space

Low free disk space watermark: 0.05 gb
Free disk space: 392.3006 gb

Totals

Connection count: 0
Queue count: 6
Virtual host count: 3

Listeners

Interface: [::], port: 15672, protocol: http, purpose: HTTP API
Interface: [::], port: 1883, protocol: mqtt, purpose: MQTT
Interface: [::], port: 61613, protocol: stomp, purpose: STOMP
Interface: [::], port: 25672, protocol: clustering, purpose: inter-node and CLI tool communication
Interface: 127.0.0.1, port: 5672, protocol: amqp, purpose: AMQP 0-9-1 and AMQP 1.0
```

### 启动

```shell
rabbitmq-server -detached
```

detached：以守护进程的方式在后台运行。

### 停止运行`Erlang`虚拟机和服务应用。

```shell
rabbitmqctl stop [pid_file]
```

pid_file：通过rabbitmq-server启动生成的文件，加`-detached`不产生。意思为需要等待指定进程的结束。

### 停止运行：阻塞直到`Erlang`虚拟机进程退出。

```shell
rabbitmqctl shutdown
```

### 停止服务应用

```shell
rabbitmqctl stop_app
```

### 启动服务应用

```shell
rabbitmqctl start_app
```

### 等待rabbitmq应用的启动

```shell
rabbitmqctl wait [pid_file]
```

### 初始化服务

```shell
rabbitmqctl reset
```

### 强制初始化服务

```shell
rabbitmqctl force_reset
```

### 切割日志

```shell
rabbitmqctl rotate_logs {suffix}
```

原日志存于日志名+后缀的文件中，不指定suffix：只是重新打开，而不发生轮换。

### 将部分代码用HiPE编译

```shell
rabbitmqctl hipe_compile {directory}
```

### 节点状态

```shell
rabbitmqctl status
```

### 健康检查

```shell
rabbitmqctl node_health_check
```

### 查看变量的名称和值。

```
rabbitmqctl environment
```

### 生成服务器状态报告

```shell
rabbitmqctl report [> report.txt]
```

为所有服务器状态生成1个服务器状态报告，并将输出重定向到1个文件。

### 执行任意 Erlang 表达式

```shell
rabbitmqctl eval {expr}
```

1. 创建交换器：`declare(XName , Type , Durable , AutoDelete , Internal, Args)`。
2. 创建队列：`declare(QueueName , Durable , AutoDelete , Args, Owner)`。
   1. Owner：用于队列的独占模式， 一般设置为 none。

## 参数管理

### vhost级别

#### 添加参数

```shell
rabbitmqctl set_parameter [-p vhost] {component_name} {name} {value}
```

#### 查看参数

```shell
rabbitmqctl list_parameters [-p vhost]
```

#### 删除参数

```shell
rabbitmqctl clear_parameter [-p vhost] {component_name} {key}
```

### global级别

#### 添加参数

```shell
rabbitmqctl set_global_parameter {name} {value}
```

#### 查看参数

```shell
rabbitmqctl list_global_parameters [-p vhost]
```

#### 删除参数

```shell
rabbitmqctl clear_global_parameter {key}
```

## 策略管理

vhost级别，可以匹配一个或多个交换器，可以支持动态修改一些参数属性

### 添加策略

```
rabbitmqctl set_policy [-p vhost] [--priority priority] [--apply-to apply-to] {name} {pattern} {definition}
```

1. priority：优先级，多个策略优先级高的执行。
2. apply-to：应用到交换器或队列。
3. name：策略名称。
4. pattern：匹配的交换器或队列的正则。
5. definition：参数，格式： {"key": "value"}

### 查看策略

```
rabbitmqctl list_policies 
```

### 删除策略

```
rabbitmqctl clear_policy [-p vhost] {name}
```

## 配置

优先级：环境变量 > 配置文件 > 默认配置

### 环境变量

|          变量名          | 含义                                                         |
| :----------------------: | :----------------------------------------------------------- |
| RABBITMQ_NODE_IP_ADDRESS | node所在的ip地址                                             |
|    RABBITMQ_NODE_PORT    | 监听客户端链接的接口，默认：5672。                           |
|    RABBITMQ_DIST_PORT    | 默认内部通信端口号，默认：25762                              |
|    RABBITMQ_NODENAME     | node的名称，默认rabbit@$HOSTNAME                             |
|  RABBITMQ_CONF_ENV_FILE  | 环境变量的配置文件的路径，默认：/$RABBITMQ_HOME/etc/rabbitmq/rabbitmq-env.conf |
|  RABBITMQ_USE_LONGNAME   | boolean值，是否显示长命名，例如：rabbit@node1.xxx            |
|    RABBITMQ_CONF_FILE    | 配置文件的路径，默认：/$RABBITMQ_HOME/etc/rabbitmq/rabbitmq  |
|   RABBITMQ_MNESIA_BASE   | RABBITMQ_MNESIA_DIR的父目录，默认值：/$RABBITMQ_HOME/var/lib/rabbitmq/manesia |
|   RABBITMQ_MNESIA_DIR    | 包含rabbitmq节点的数据库，数据存储和集群状态的目录，默认值为RABBITMQ_MNESIA_BASE/RABBITMQ_NODENAME |
|    RABBITMQ_LOG_BASE     | 服务日志的目录，默认：/$RABBITMQ_HOME/var/log/rabbitmq       |
|      RABBITMQ_LOGS       | 和ERAING相关的日志，默认：RABBITMQ_LOG_BASE/RABBITMQ_NODENAME.log |
|    RABBITMQ_SASL_LOGS    | SASL相关的日志，默认：RABBITMQ_LOG_BASE/RABBITMQ_NODENAME-sasl.log |
|   RABBITMQ_PLUGINS_DIR   | 插件所在路径，默认：/$RABBITMQ_HOME/plugins/                 |

## [参考代码](exercises/src/main/java/com/normal)